## 题目
**Web反向代理，正向端口转发，反向端口转发，动态端口转发, 内网反弹shell，外网forward shell，正向socks/http代理，反向socks/http代理, 正向vpn,反向bridge vpn. 一般是怎样理解的，分别有哪些代表性的工具，你经常使用哪一款？**


 - **Q:代理技术**  
 - A:见代理技术.md
 

 - **Q:正向代理和反向代理**  
 - A:正向代理代理客户端，反向代理代理服务器。正向代理中，proxy和client同属一个LAN，对server透明；反向代理中，proxy和server同属一个LAN，对client透明。反向代理：由于单个服务器的处理客户端（用户）请求能力有一个极限，当用户的接入请求蜂拥而入时，会造成服务器忙不过来的局面，可以使用多个服务器来共同分担成千上万的用户请求，这些服务器提供相同的服务，对于用户来说，根本感觉不到任何差别。应用：反向代理方式和包过滤方式或普通代理方式并无冲突，因此可以在防火墙设备中同时使用这两种方式，其中反向代理用于外部网络访问内部网络时使用，正向代理或包过滤方式用于拒绝其他外部访问方式并提供内部网络对外部网络的访问能力。因此可以结合这些方式提供最佳的安全访问方式。
 参考：http://www.zjicmisa.org/index.php/archives/160/ 一些关于代理的知识。

 - **Q:正向代理的应用场景**  
 - A:如果不采用代理，用户的IP、端口号直接暴露在Internet（尽管地址转换NAT），外部主机依然可以根据IP、端口号来开采主机安全漏洞，所以在企业网，一般都是采用代理服务器访问互联网。而代理服务器数量不多，修补安全漏洞更方便及时。

 - **Q:正向代理技术的分类**  
 - A:HTTP代理，FTP代理，POP3代理，SOCKS4/5代理等。工具包括代理防火墙，squid，bs，fd，httprequest。

     - **实验1：squid和正向代理。**

 - Q:服务代理和socks代理的区别
 - A:区别如下：
服务代理：代理客户端的web服务访问，比如代理http，ftp，pop3服务等；
SOCKS代理：SOCKS代理与其他类型的代理不同，它只是简单地传递数据包，而并不关心是何种应用协议，既可以是HTTP请求，也可以是其他服务的代理。所以 SOCKS 代理服务器比其他类型的代理服务器速度要快得多。SOCKS代理又分为SOCKS4和SOCKS5，二者不同的是SOCKS4代理只支持TCP协议（即传输控制协议），而SOCKS5代理则既支持TCP协议又支持UDP协议（即用户数据包协议），还支持各种身份验证机制、服务器端域名解析等。 SOCK4能做到的SOCKS5都可得到，比如我们常用的聊天工具QQ在使用代理时就要求用SOCKS5代理，因为它需要使用UDP协议来传输数据。

    - 实验2：ssh实现socks5代理

    - 实验3：ssh隧道穿透防火墙

- **Q:vpn，ss，ssr 是什么？**
- A:  
**0x01 VPN是什么？**  
VPN，全称：Virtual Private Network，译：虛拟私人网络。作用：提供安全可靠的通信渠道，一般而言企业使用较多。延伸作用：科学上网。说明：VPN的出现并不是为了“科学上网”，二是在公网上建立加密的通信渠道。例如，公司员工出差或者在寝室，想要登录公司内网服务怎么办？这时VPN就派上用场了，可以通过第三方连接工具进行远程连接。  
**0x02 SS是什么？**  
SS全称shadowsocks，一开始为个人独立开发并用作“科学上网”，后被大家所熟知和广泛使用。  
**0x03 SSR是什么？**  
SSR全称shadowsocks-R。SSR作者声称SS不够隐匿，容易被防火墙检测到，SSR改进了协议，增加了混淆，更难被防火墙检测到。简单地说，SSR是SS的改进版。  
**0x04 VPN与SSR、SS的区别？**    
SS和SSR在client到代理服务器之间是加密传送，代理服务器到请求的服务之间走原来的服务协议。  
VPN在端和端之间建立隧道，加密是可选项，有些vpn协议不支持加密。VPN 是构建虚拟专用网，本质上是构建了一个网络，数据通过虚拟网络的设置路径进出。例如，一条通过GRE协议在两台主机间创建的隧道属于虚拟私人网络，但既不安全也不可信。明文隧道协议包括L2TP（不带IPsec时）和PPTP（不使用微软点对点加密(MPPE)时）    
    - **实验4：ss5和ss/ssr**

- **Q：端口映射和端口转发的区别**
- A：  
端口映射就是将外网主机的IP地址的一个端口映射到内网中一台机器，提供相应的服务。当用户访问该IP的这个端口时，服务器自动将请求映射到对应局域网内部的机器上。端口映射有动态和静态之分。  
具体来讲，端口映射是将一台主机的内网(LAN)IP地址映射成一个公网(WAN)IP地址，当用户访问提供映射端口主机的某个端口时，服务器将请求转移到本地局域网内部提供这种特定服务的主机；利用端口映射功能还可以将一台外网IP地址机器的多个端口映射到内网不同机器上的不同端口。   端口映射功能还可以完成一些特定代理功能，比如代理POP，SMTP，TELNET等协议。理论上可以提供65535(总端口数)-1024(保留端口数)=64511个端口的映射。举例说明如何设置端口映射：例如要映射一台IP地址为192.168.111.10的WEB服务器，只需把服务器的IP地址192.168.111.10和提供web服务的TCP端口80填入到路由器的端口映射表中即可。
转发，先收再转，一般来说是服务器，收到数据包后转发给后端，后端不会直接看到SRC IP是远端，而是转发服务器的IP地址请求。  
一般家用路由器带有的都是映射。特别要注意，一般情况下，纯内网的机器网关要指向转发服务器，这样数据包才能回去。转发有点像proxy，有代理的功能，可以代理纯内网机器的端口。
转发安全性好。  

    - **实验5：家用路由的端口映射（重点：与转发比较）**
    
- **Q:反向代理的实现**
- A:反向代理的实现：1）需要有一个负载均衡设备来分发用户请求，将用户请求分发到空闲的web服务器上；2）web服务器返回自己的服务到负载均衡设备；3）负载均衡将web服务器的服务返回用户。用户和负载均衡设备直接通信，也意味着用户做域名解析时，解析得到的IP其实是负载均衡的IP，而不是web服务器的IP，这样有一个好处是， 当新加入/移走web服务器时，仅仅需要修改负载均衡的服务器列表， 而不会影响现有的服务。  
    - **实验6：安装web服务器（nginx)**  
    - **实验7：利用nginx搭建反向代理**  

- **Q：正向端口转发和反向端口转发，和动态端口转发**
- A：  
正向端口转发，把本地主机端口通过待登录主机端口转发到远程主机端口上去。  
反向端口转发，把登录主机端口通过本地主机端口转发到远程主机上。  
动态端口转发，这里常见的应用就是 ssh 的动态绑定。因此动态端口转发也就离不开 ssh 的一些相关应用，例如翻墙。首先，墙内的客户机跟墙外的代理服务器，建立好 SSH 连接，并设定动态绑定；此时墙内客户机上的 SSH 会监听本地的一个端口 7001；客户机上的程序，将对 www.youtube.com:80 的请求告知 7001 端口的 SSH，SSH 将此请求通过 SSH 加密连接发送到墙外服务器的 SSH 上。由于建立的动态绑定，服务器会将 www.youtube.com:80 的请求发送给 www.youtube.com 上的 80 端口，并在收到回复后，通过原路返回给客户机的 SSH，客户机的 SSH 返回给应用程序。在这里 SSH 客户端已经不仅仅是个客户端了，它同时打开了 7001 端口侦听本机应用程序的请求。这是 SSH 跟传统用法最大的区别。而服务端的 SSH 也不仅仅是处理客户端的请求，而是将请求转发到对应的主机和端口，这里的 “动态” 二字体现在服务端的 SSH 的转发目标是不固定的，是根据客户端的请求而定的。

### 这里设置一个实验，正向和方向的对比。

- Q：正向 socks/http 代理，反向 socks/http 代理
- A：先阐述 http 代理和 socks 代理的区别。SOCKS 工作在比 HTTP 代理更低的层次：SOCKS 使用握手协议来通知代理软件其客户端试图进行的连接 SOCKS， 然后尽可能透明地进行操作， 而常规代理可能会解释和重写报头（例如，使用另一种底层协议，例如 FTP；然而，HTTP 代理只是将 HTTP 请求转发到所需的 HTTP 服务器）。虽然 HTTP 代理有不同的使用模式，CONNECT 方法允许转发 TCP 连接；然而，SOCKS 代理还可以转发 UDP 流量和反向代理，而 HTTP 代理不能。HTTP 代理通常更了解 HTTP 协议，执行更高层次的过滤。
回到主题上，正向 socks/http 代理应该就是我们最常见的这种浏览器代理，通过代理服务器来进行抓包或者传送流量给对方服务器， 常见工具的话就是 burp 或者 fd。
反向代理是先在服务器 A（比如攻击机）上运行 SOCKS 代理的服务端程序监听指定端口，然后在客户机（比如靶机）上运行客户端程序连接服务器的指定端口。这样就建立了一条从靶机到攻击机的反向 SOCKS 隧道，攻击机的应用程序（比如 wget nmap curl … ）使用该隧道后， 程序的所有流量都会先经过靶机转发出去。
应该不是很难理解，就是从客户机上创建了一个隧道反向连接到我们的服务器，服务器的流量就可以通过从这个隧道出去，实现流量的匿名。常见的工具就是 proxychains（linux下） 了吧。

- Q：正向 vpn, 反向 bridge vpn
- A：正向 vpn 应该比较好理解，就是一般常见的 vpn 结构，我们客户机连接到墙外的服务器，然后通过这个创建的隧道进行流量的传输。

反向桥接 vpn 这里举一个例子开头，在参加 ctf 线下赛时，我们时常需要下载官方提供的 vpn 软件，然后通过注册的账号密码来登录这个 vpn，登录成功后会显示我们本机被分配的一个内网 ip，最后通过 vpn 客户端我们才能访问比赛题目。

这里用到两种技术，一种是反向 vpn，一种是桥接模式。对于桥接模式应该比较好理解，就是指本地物理网卡和虚拟网卡通过 VMnet0 虚拟交换机进行桥接，物理网卡和虚拟网卡在拓扑图上处于同等地位，那么物理网卡和虚拟网卡就相当于处于同一个网段，虚拟交换机就相当于一台现实网络中的交换机。借助这种架构方式，我们可以通过互联网将客户端和服务端联系起来，使得用户可以在任意联网的机器上，接入运行服务端机器所在的局域网网络，服务器端无需外网 IP 及防火墙特殊设置即可实现远程接入。
那么反向 vpn 最常见的应用可能就是 vpn pivoting。下面来简单的介绍一下 vpn pivoting。这是 vpn pivoting 的一个工作架构。攻击机会虚拟出一个网络接口与目标机进行对接，任何应用如果想要访问目标机里的网络，那么就会通过这个虚拟的网络接口进行流量的传输，通过 vpn 隧道到达目标机的网络，这时候目标机的 vpn 软件会监听这个隧道的流量，然后通过 TUN/TAP 驱动将流量传输到网络接口，从而让攻击机能够访问到目标机的网络。
